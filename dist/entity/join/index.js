!function(t,e,i){"use strict";function s(e){if(this.support=!("undefined"==typeof File||"undefined"==typeof Blob||"undefined"==typeof FileList||!Blob.prototype.slice&&!Blob.prototype.webkitSlice&&!Blob.prototype.mozSlice),this.support){this.supportDirectory=/WebKit/.test(t.navigator.userAgent),this.files=[],this.defaults={chunkSize:1048576,forceChunkSize:!1,simultaneousUploads:3,singleFile:!1,fileParameterName:"file",progressCallbacksInterval:500,speedSmoothingFactor:.1,query:{},headers:{},withCredentials:!1,preprocess:null,method:"multipart",testMethod:"GET",uploadMethod:"POST",prioritizeFirstAndLastChunk:!1,target:"/",testChunks:!0,generateUniqueIdentifier:null,maxChunkRetries:0,chunkRetryInterval:null,permanentErrors:[404,415,500,501],successStatuses:[200,201,202],onDropStopPropagation:!1},this.opts={},this.events={};var i=this;this.onDrop=function(t){i.opts.onDropStopPropagation&&t.stopPropagation(),t.preventDefault();var e=t.dataTransfer;e.items&&e.items[0]&&e.items[0].webkitGetAsEntry?i.webkitReadDataTransfer(t):i.addFiles(e.files,t)},this.preventEvent=function(t){t.preventDefault()},this.opts=s.extend({},this.defaults,e||{})}}function n(t,e){this.flowObj=t,this.file=e,this.name=e.fileName||e.name,this.size=e.size,this.relativePath=e.relativePath||e.webkitRelativePath||this.name,this.uniqueIdentifier=t.generateUniqueIdentifier(e),this.chunks=[],this.paused=!1,this.error=!1,this.averageSpeed=0,this.currentSpeed=0,this._lastProgressCallback=Date.now(),this._prevUploadedSize=0,this._prevProgress=0,this.bootstrap()}function r(t,e,i){this.flowObj=t,this.fileObj=e,this.fileObjSize=e.size,this.offset=i,this.tested=!1,this.retries=0,this.pendingRetry=!1,this.preprocessState=0,this.loaded=0,this.total=0;var s=this.flowObj.opts.chunkSize;this.startByte=this.offset*s,this.endByte=Math.min(this.fileObjSize,(this.offset+1)*s),this.xhr=null,this.fileObjSize-this.endByte<s&&!this.flowObj.opts.forceChunkSize&&(this.endByte=this.fileObjSize);var n=this;this.event=function(t,e){e=Array.prototype.slice.call(arguments),e.unshift(n),n.fileObj.chunkEvent.apply(n.fileObj,e)},this.progressHandler=function(t){t.lengthComputable&&(n.loaded=t.loaded,n.total=t.total),n.event("progress",t)},this.testHandler=function(t){var e=n.status(!0);"error"===e?(n.event(e,n.message()),n.flowObj.uploadNextChunk()):"success"===e?(n.tested=!0,n.event(e,n.message()),n.flowObj.uploadNextChunk()):n.fileObj.paused||(n.tested=!0,n.send())},this.doneHandler=function(t){var e=n.status();if("success"===e||"error"===e)n.event(e,n.message()),n.flowObj.uploadNextChunk();else{n.event("retry",n.message()),n.pendingRetry=!0,n.abort(),n.retries++;var i=n.flowObj.opts.chunkRetryInterval;null!==i?setTimeout(function(){n.send()},i):n.send()}}}function a(t,e){var i=t.indexOf(e);i>-1&&t.splice(i,1)}function o(t,e){return"function"==typeof t&&(e=Array.prototype.slice.call(arguments),t=t.apply(null,e.slice(1))),t}function h(t,e){setTimeout(t.bind(e),0)}function l(t,e){return d(arguments,function(e){e!==t&&d(e,function(e,i){t[i]=e})}),t}function d(t,e,i){if(t){var s;if("undefined"!=typeof t.length){for(s=0;s<t.length;s++)if(e.call(i,t[s],s)===!1)return}else for(s in t)if(t.hasOwnProperty(s)&&e.call(i,t[s],s)===!1)return}}var p=t.navigator.msPointerEnabled;s.prototype={on:function(t,e){t=t.toLowerCase(),this.events.hasOwnProperty(t)||(this.events[t]=[]),this.events[t].push(e)},off:function(t,e){t!==i?(t=t.toLowerCase(),e!==i?this.events.hasOwnProperty(t)&&a(this.events[t],e):delete this.events[t]):this.events={}},fire:function(t,e){e=Array.prototype.slice.call(arguments),t=t.toLowerCase();var i=!1;return this.events.hasOwnProperty(t)&&d(this.events[t],function(t){i=t.apply(this,e.slice(1))===!1||i},this),"catchall"!=t&&(e.unshift("catchAll"),i=this.fire.apply(this,e)===!1||i),!i},webkitReadDataTransfer:function(t){function e(t){a+=t.length,d(t,function(t){if(t.isFile){var n=t.fullPath;t.file(function(t){i(t,n)},s)}else t.isDirectory&&t.createReader().readEntries(e,s)}),n()}function i(t,e){t.relativePath=e.substring(1),o.push(t),n()}function s(t){throw t}function n(){0==--a&&r.addFiles(o,t)}var r=this,a=t.dataTransfer.items.length,o=[];d(t.dataTransfer.items,function(t){var r=t.webkitGetAsEntry();return r?void(r.isFile?i(t.getAsFile(),r.fullPath):r.createReader().readEntries(e,s)):void n()})},generateUniqueIdentifier:function(t){var e=this.opts.generateUniqueIdentifier;if("function"==typeof e)return e(t);var i=t.relativePath||t.webkitRelativePath||t.fileName||t.name;return t.size+"-"+i.replace(/[^0-9a-zA-Z_-]/gim,"")},uploadNextChunk:function(t){var e=!1;if(this.opts.prioritizeFirstAndLastChunk&&(d(this.files,function(t){return!t.paused&&t.chunks.length&&"pending"===t.chunks[0].status()&&0===t.chunks[0].preprocessState?(t.chunks[0].send(),e=!0,!1):!t.paused&&t.chunks.length>1&&"pending"===t.chunks[t.chunks.length-1].status()&&0===t.chunks[0].preprocessState?(t.chunks[t.chunks.length-1].send(),e=!0,!1):void 0}),e))return e;if(d(this.files,function(t){return t.paused||d(t.chunks,function(t){return"pending"===t.status()&&0===t.preprocessState?(t.send(),e=!0,!1):void 0}),e?!1:void 0}),e)return!0;var i=!1;return d(this.files,function(t){return t.isComplete()?void 0:(i=!0,!1)}),i||t||h(function(){this.fire("complete")},this),!1},assignBrowse:function(t,i,s,n){"undefined"==typeof t.length&&(t=[t]),d(t,function(t){var r;"INPUT"===t.tagName&&"file"===t.type?r=t:(r=e.createElement("input"),r.setAttribute("type","file"),l(r.style,{visibility:"hidden",position:"absolute"}),t.appendChild(r),t.addEventListener("click",function(){r.click()},!1)),this.opts.singleFile||s||r.setAttribute("multiple","multiple"),i&&r.setAttribute("webkitdirectory","webkitdirectory"),d(n,function(t,e){r.setAttribute(e,t)});var a=this;r.addEventListener("change",function(t){a.addFiles(t.target.files,t),t.target.value=""},!1)},this)},assignDrop:function(t){"undefined"==typeof t.length&&(t=[t]),d(t,function(t){t.addEventListener("dragover",this.preventEvent,!1),t.addEventListener("dragenter",this.preventEvent,!1),t.addEventListener("drop",this.onDrop,!1)},this)},unAssignDrop:function(t){"undefined"==typeof t.length&&(t=[t]),d(t,function(t){t.removeEventListener("dragover",this.preventEvent),t.removeEventListener("dragenter",this.preventEvent),t.removeEventListener("drop",this.onDrop)},this)},isUploading:function(){var t=!1;return d(this.files,function(e){return e.isUploading()?(t=!0,!1):void 0}),t},_shouldUploadNext:function(){var t=0,e=!0,i=this.opts.simultaneousUploads;return d(this.files,function(s){d(s.chunks,function(s){return"uploading"===s.status()&&(t++,t>=i)?(e=!1,!1):void 0})}),e&&t},upload:function(){var t=this._shouldUploadNext();if(t!==!1){this.fire("uploadStart");for(var e=!1,i=1;i<=this.opts.simultaneousUploads-t;i++)e=this.uploadNextChunk(!0)||e;e||h(function(){this.fire("complete")},this)}},resume:function(){d(this.files,function(t){t.resume()})},pause:function(){d(this.files,function(t){t.pause()})},cancel:function(){for(var t=this.files.length-1;t>=0;t--)this.files[t].cancel()},progress:function(){var t=0,e=0;return d(this.files,function(i){t+=i.progress()*i.size,e+=i.size}),e>0?t/e:0},addFile:function(t,e){this.addFiles([t],e)},addFiles:function(t,e){var i=[];d(t,function(t){if((!p||p&&t.size>0)&&(t.size%4096!==0||"."!==t.name&&"."!==t.fileName)&&!this.getFromUniqueIdentifier(this.generateUniqueIdentifier(t))){var s=new n(this,t);this.fire("fileAdded",s,e)&&i.push(s)}},this),this.fire("filesAdded",i,e)&&d(i,function(t){this.opts.singleFile&&this.files.length>0&&this.removeFile(this.files[0]),this.files.push(t)},this),this.fire("filesSubmitted",i,e)},removeFile:function(t){for(var e=this.files.length-1;e>=0;e--)this.files[e]===t&&(this.files.splice(e,1),t.abort())},getFromUniqueIdentifier:function(t){var e=!1;return d(this.files,function(i){i.uniqueIdentifier===t&&(e=i)}),e},getSize:function(){var t=0;return d(this.files,function(e){t+=e.size}),t},sizeUploaded:function(){var t=0;return d(this.files,function(e){t+=e.sizeUploaded()}),t},timeRemaining:function(){var t=0,e=0;return d(this.files,function(i){i.paused||i.error||(t+=i.size-i.sizeUploaded(),e+=i.averageSpeed)}),t&&!e?Number.POSITIVE_INFINITY:t||e?Math.floor(t/e):0}},n.prototype={measureSpeed:function(){var t=Date.now()-this._lastProgressCallback;if(t){var e=this.flowObj.opts.speedSmoothingFactor,i=this.sizeUploaded();this.currentSpeed=Math.max((i-this._prevUploadedSize)/t*1e3,0),this.averageSpeed=e*this.currentSpeed+(1-e)*this.averageSpeed,this._prevUploadedSize=i}},chunkEvent:function(t,e,i){switch(e){case"progress":if(Date.now()-this._lastProgressCallback<this.flowObj.opts.progressCallbacksInterval)break;this.measureSpeed(),this.flowObj.fire("fileProgress",this,t),this.flowObj.fire("progress"),this._lastProgressCallback=Date.now();break;case"error":this.error=!0,this.abort(!0),this.flowObj.fire("fileError",this,i,t),this.flowObj.fire("error",i,this,t);break;case"success":if(this.error)return;this.measureSpeed(),this.flowObj.fire("fileProgress",this,t),this.flowObj.fire("progress"),this._lastProgressCallback=Date.now(),this.isComplete()&&(this.currentSpeed=0,this.averageSpeed=0,this.flowObj.fire("fileSuccess",this,i,t));break;case"retry":this.flowObj.fire("fileRetry",this,t)}},pause:function(){this.paused=!0,this.abort()},resume:function(){this.paused=!1,this.flowObj.upload()},abort:function(t){this.currentSpeed=0,this.averageSpeed=0;var e=this.chunks;t&&(this.chunks=[]),d(e,function(t){"uploading"===t.status()&&(t.abort(),this.flowObj.uploadNextChunk())},this)},cancel:function(){this.flowObj.removeFile(this)},retry:function(){this.bootstrap(),this.flowObj.upload()},bootstrap:function(){this.abort(!0),this.error=!1,this._prevProgress=0;for(var t=this.flowObj.opts.forceChunkSize?Math.ceil:Math.floor,e=Math.max(t(this.file.size/this.flowObj.opts.chunkSize),1),i=0;e>i;i++)this.chunks.push(new r(this.flowObj,this,i))},progress:function(){if(this.error)return 1;if(1===this.chunks.length)return this._prevProgress=Math.max(this._prevProgress,this.chunks[0].progress()),this._prevProgress;var t=0;d(this.chunks,function(e){t+=e.progress()*(e.endByte-e.startByte)});var e=t/this.size;return this._prevProgress=Math.max(this._prevProgress,e>.9999?1:e),this._prevProgress},isUploading:function(){var t=!1;return d(this.chunks,function(e){return"uploading"===e.status()?(t=!0,!1):void 0}),t},isComplete:function(){var t=!1;return d(this.chunks,function(e){var i=e.status();return"pending"===i||"uploading"===i||1===e.preprocessState?(t=!0,!1):void 0}),!t},sizeUploaded:function(){var t=0;return d(this.chunks,function(e){t+=e.sizeUploaded()}),t},timeRemaining:function(){if(this.paused||this.error)return 0;var t=this.size-this.sizeUploaded();return t&&!this.averageSpeed?Number.POSITIVE_INFINITY:t||this.averageSpeed?Math.floor(t/this.averageSpeed):0},getType:function(){return this.file.type&&this.file.type.split("/")[1]},getExtension:function(){return this.name.substr((~-this.name.lastIndexOf(".")>>>0)+2).toLowerCase()}},r.prototype={getParams:function(){return{flowChunkNumber:this.offset+1,flowChunkSize:this.flowObj.opts.chunkSize,flowCurrentChunkSize:this.endByte-this.startByte,flowTotalSize:this.fileObjSize,flowIdentifier:this.fileObj.uniqueIdentifier,flowFilename:this.fileObj.name,flowRelativePath:this.fileObj.relativePath,flowTotalChunks:this.fileObj.chunks.length}},getTarget:function(t,e){return t+=t.indexOf("?")<0?"?":"&",t+e.join("&")},test:function(){this.xhr=new XMLHttpRequest,this.xhr.addEventListener("load",this.testHandler,!1),this.xhr.addEventListener("error",this.testHandler,!1);var t=o(this.flowObj.opts.testMethod,this.fileObj,this),e=this.prepareXhrRequest(t,!0);this.xhr.send(e)},preprocessFinished:function(){this.preprocessState=2,this.send()},send:function(){var t=this.flowObj.opts.preprocess;if("function"==typeof t)switch(this.preprocessState){case 0:return this.preprocessState=1,void t(this);case 1:return}if(this.flowObj.opts.testChunks&&!this.tested)return void this.test();this.loaded=0,this.total=0,this.pendingRetry=!1;var e=this.fileObj.file.slice?"slice":this.fileObj.file.mozSlice?"mozSlice":this.fileObj.file.webkitSlice?"webkitSlice":"slice",i=this.fileObj.file[e](this.startByte,this.endByte,this.fileObj.file.type);this.xhr=new XMLHttpRequest,this.xhr.upload.addEventListener("progress",this.progressHandler,!1),this.xhr.addEventListener("load",this.doneHandler,!1),this.xhr.addEventListener("error",this.doneHandler,!1);var s=o(this.flowObj.opts.uploadMethod,this.fileObj,this),n=this.prepareXhrRequest(s,!1,this.flowObj.opts.method,i);this.xhr.send(n)},abort:function(){var t=this.xhr;this.xhr=null,t&&t.abort()},status:function(t){return this.pendingRetry||1===this.preprocessState?"uploading":this.xhr?this.xhr.readyState<4?"uploading":this.flowObj.opts.successStatuses.indexOf(this.xhr.status)>-1?"success":this.flowObj.opts.permanentErrors.indexOf(this.xhr.status)>-1||!t&&this.retries>=this.flowObj.opts.maxChunkRetries?"error":(this.abort(),"pending"):"pending"},message:function(){return this.xhr?this.xhr.responseText:""},progress:function(){if(this.pendingRetry)return 0;var t=this.status();return"success"===t||"error"===t?1:"pending"===t?0:this.total>0?this.loaded/this.total:0},sizeUploaded:function(){var t=this.endByte-this.startByte;return"success"!==this.status()&&(t=this.progress()*t),t},prepareXhrRequest:function(t,e,i,s){var n=o(this.flowObj.opts.query,this.fileObj,this,e);n=l(this.getParams(),n);var r=o(this.flowObj.opts.target,this.fileObj,this,e),a=null;if("GET"===t||"octet"===i){var h=[];d(n,function(t,e){h.push([encodeURIComponent(e),encodeURIComponent(t)].join("="))}),r=this.getTarget(r,h),a=s||null}else a=new FormData,d(n,function(t,e){a.append(e,t)}),a.append(this.flowObj.opts.fileParameterName,s,this.fileObj.file.name);return this.xhr.open(t,r,!0),this.xhr.withCredentials=this.flowObj.opts.withCredentials,d(o(this.flowObj.opts.headers,this.fileObj,this,e),function(t,e){this.xhr.setRequestHeader(e,t)},this),a}},s.evalOpts=o,s.extend=l,s.each=d,s.FlowFile=n,s.FlowChunk=r,s.version="2.9.0","object"==typeof module&&module&&"object"==typeof module.exports?module.exports=s:(t.Flow=s,"function"==typeof define&&define.amd&&define("flow",[],function(){return s}))}(window,document),jQuery=$,$(function(){"use strict";function t(t){b.entity=t,window.wechat.share({link:location.origin+"/entity/"+t.id,title:t.title,description:t.content}),$('<link rel="stylesheet"/>').attr("href","/page/"+t.Theme.code+"/css/style.css").appendTo("head"),$.get("/page/"+t.Theme.code+"/index.html",function(t){$('<script id="card-template" type="text/html"/>').html(t).appendTo("body"),f=$(".panel"),e(),i(),s(),r(),o()})}function e(){var t=$(".join-footer-bar"),e=10;t.find(".join-footer-bar-list").on("click",function(){n(),g.addClass("smaller"),m.addClass("in")}),t.find(".join-footer-bar-add").on("click",function(){b.cards.length<e&&o(),b.cards.length>=e&&$(this).addClass("disabled")}),t.find(".join-footer-bar-layout").on("click",function(){a(b.cards[w.activeIndex]),g.addClass("smaller"),v.addClass("in")}),t.find(".join-footer-bar-publish").on("click",function(){var t=[],e=b.cards.every(function(e,i){t.push({contents:e.contents,pictures:e.pictures,layoutId:e.Layout.id});var s=$(w.slides[i]),n=s.find(".picture").length,r=s.find(".content").length,a=e.pictures.filter(function(t){return t!=y}),o=e.contents.filter(function(t){return t});if(n){if(a.length<n)return w.slideTo(i),alert("请先上传图片再发布！"),!1}else if(o.length<r)return w.slideTo(i),alert("请先上传填写文字再发布！"),!1;return!0});if(e){$(this).addClass("disabled");var i={entityId:b.entity.id,cards:t};$.post("/services/post"+u,i,function(t){"success"==t.status?location.href="/entity/"+t.data.entityId+"/joined/"+t.data.id:console.error(t)})}})}function i(){g=$(".preview-container").html(template("preview-template",b)),w=new Swiper(g[0],{preloadImages:!1,lazyLoading:!0,lazyLoadingInPrevNext:!0,lazyLoadingOnTransitionStart:!0,onTap:function(){g.removeClass("smaller"),m.removeClass("in"),v.removeClass("in")}})}function s(){m=$(".card-list");var t=m.find(".swiper-container"),e=t.height(),i=f.height(),s=e/i,r=t.css({height:i})[0].style;r.webkitTransform=r.MsTransform=r.msTransform=r.MozTransform=r.OTransform=r.transform="scale("+s+")",m.find(".join-bar-close").on("click",function(){if(b.deletedCards.length){var t,e,i=b.cards.slice(0);for(t=b.deletedCards.length-1;t>=0;t--)i.splice(b.deletedCards[t][0],0,b.deletedCards[t][1]);for(b.deletedCards=[],b.cards=[],w.removeAllSlides(),t=0,e=i.length;e>t;t++)o(i[t])}g.removeClass("smaller"),m.removeClass("in")}),m.find(".join-bar-save").on("click",function(){b.deletedCards=[],g.removeClass("smaller"),m.removeClass("in")}),m.on("click",".join-bar-remove",function(){var t=$(this).parent().index();b.deletedCards.push([t,b.cards[t]]),b.cards.splice(t,1),w.removeSlide(t),n()})}function n(){var t=$(".card-list .swiper-container").html(template("card-list-template",b));t[0].swiper&&t[0].swiper.destroy(),new Swiper(t[0],{slideActiveClass:"active",initialSlide:w.activeIndex,spaceBetween:200,slideToClickedSlide:!0,preloadImages:!1,lazyLoading:!0,lazyLoadingInPrevNext:!0,lazyLoadingOnTransitionStart:!0,onSlideChangeStart:function(t){w.slideTo(t.activeIndex)}})}function r(){v=$(".layout-list"),v.find(".join-bar-close").on("click",function(){g.removeClass("smaller"),v.removeClass("in");var t=b.cards[w.activeIndex];t.layout_origin&&(t.Layout=t.layout_origin,t.layoutId=t.Layout.id,t.layout_origin=null,h(t))}),v.find(".join-bar-save").on("click",function(){g.removeClass("smaller"),v.removeClass("in"),b.cards[w.activeIndex].layout_origin=null})}function a(t){var e,i,s=b.entity.Theme,n=$(".layout-list .swiper-container").html(template("layout-list-template",s));for(e=0,i=s.Layouts.length;i>e&&t.Layout.code!=s.Layouts[e].code;e++);n[0].swiper&&n[0].swiper.destroy(),new Swiper(n[0],{slideActiveClass:"active",initialSlide:e,slidesPerView:3,centeredSlides:!0,slideToClickedSlide:!0,onSlideChangeStart:function(e){var i=e.activeIndex,n=s.Layouts[i];t.layout_origin=t.Layout,t.Layout=n,t.layoutId=t.Layout.id,h(t)}})}function o(t){if(!t){var e=b.entity.Theme.Layouts[0];t={layoutId:e.id,Layout:e,contents:[],pictures:[y]}}if(b.cards.push(t),w){w.appendSlide('<div class="swiper-slide">'+template("card-template",t)+"</div>");var i=w.slides.length-1,s=$(w.slides[i]);w.slideTo(i),w.lazy.loadImageInSlide(i),l(s,t)}}function h(t){var e=b.cards.indexOf(t);w&&(w.slides[e].innerHTML=template("card-template",t),w.lazy.loadImageInSlide(e),l($(w.slides[e]),t))}function l(t,e){t.find(".picture").each(function(t){e.pictures[t]==y&&$(this).addClass("picture-default"),d(this,e,t)}),t.find(".content").each(function(t){function i(){for(s=a.val(),n=o.val(s).scrollTop(1e4).scrollTop(),n=Math.max(n,h);n>l;)s=s.slice(0,-1),n=o.val(s).scrollTop(1e4).scrollTop();a.val(s).css({height:n})}var s,n,r=$(this).html(""),a=$('<textarea rows="2" class="input-content"/>').attr("placeholder","输入内容").appendTo(r),o=a.clone().addClass("input-content-clone").height(0).appendTo(r),h=a.height(),l=Math.ceil(parseFloat(r.css("line-height"))*r.attr("data-row"));a.val(e.contents[t]||""),i(),e.contents[t]=a.val(),a.val(s).css({height:n}).on("blur",function(){e.contents[t]=a.val()}).on("paste",function(){setTimeout(i,0)}).on("keyup",i)})}function d(t,e,i){var s=$(t),n=new Flow({target:"/upload"+u,chunkSize:1024*x*1024,testChunks:!1});n.assignBrowse(t,!1,!0,{accept:"image/*"}),n.on("fileAdded",function(t){s.addClass("uploading").append('<div class="upload-mask"><p class="upload-tip">图片上传中...</p></div>'),$(".join-footer-bar-publish").addClass("disabled")}),n.on("filesSubmitted",function(t){n.upload()}),n.on("complete",function(t){s.removeClass("uploading").find(".upload-mask").remove(),$(".join-footer-bar-publish").removeClass("disabled")}),n.on("fileSuccess",function(t,n){var r;try{r=JSON.parse(n)}catch(a){console.error(n)}if("success"==r.status){var o=r.data[0].replace(/\\/g,"/");p({src:o,width:s.width(),height:s.height()},function(t){e.pictures[i]=t.replace(/\\/g,"/"),h(e)})}else"warning"==r.status&&"FILE_SIZE_TOO_LARGE"==r.data?alert("上传文件大小不得大于"+x+"M！"):console.log(r)})}function p(t,e){var i=$(template("picture-resize-template",t)).appendTo(f),s=i.find("img").cropper({aspectRatio:t.width/t.height,autoCropArea:.75,resizable:!1,movable:!1,dragCrop:!1});i.find(".btn-save").on("click",function(){var n=s.cropper("getCroppedCanvas",t),r=c(n,"image/jpeg",.8),a=t.src.split("/").pop().split(".")[0]+".jpg",o=new FormData;o.append("file",r,a),o.append("origin_file",t.src),$.ajax({type:"post",url:"/upload"+u,data:o,contentType:!1,processData:!1,success:function(t){"success"==t.status?(s.cropper("destroy"),i.remove(),e(t.data[0])):"warning"==t.status&&"FILE_SIZE_TOO_LARGE"==t.data?alert("上传文件大小不得大于"+x+"M！"):console.log(t)}})}),i.find(".btn-cancel").on("click",function(){i.remove()})}function c(t,e,i){for(var s=atob(t.toDataURL(e,i).split(",")[1]),n=s.length,r=new Uint8Array(n),a=0;n>a;a++)r[a]=s.charCodeAt(a);return new Blob([r],{type:e||"image/png"})}var u,f,g,m,v,w,b={cards:[],deletedCards:[]},x=1,y="/entity/join/img/picture-placeholder.jpg";window.wechat.auth(function(e){u="?"+$.param({_username:e.username,_password:e.password});var i=location.pathname.split("/").slice(1)[1];$.getJSON("/services/entity/"+i,function(e){if("success"==e.status){var i=e.data;if("accept"!=i.status)return void console.error("ENTITY_IS_PENDING");$.getJSON("/services/theme/"+i.themeId,function(e){"success"==e.status&&(i.Theme=e.data,t(i))})}else console.error(e.data)})})}),function(t){"function"==typeof define&&define.amd?define(["jquery"],t):t("object"==typeof exports?require("jquery"):jQuery)}(function(t){"use strict";function e(t){return"number"==typeof t&&!isNaN(t)}function i(t){return"undefined"==typeof t}function s(t,i){var s=[];return e(i)&&s.push(i),s.slice.apply(t,s)}function n(t,e){var i=s(arguments,2);return function(){return t.apply(e,i.concat(s(arguments)))}}function r(t){var e=t.match(/^(https?:)\/\/([^\:\/\?#]+):?(\d*)/i);return e&&(e[1]!==u.protocol||e[2]!==u.hostname||e[3]!==u.port)}function a(t){var e="timestamp="+(new Date).getTime();return t+(-1===t.indexOf("?")?"?":"&")+e}function o(t){return t?"rotate("+t+"deg)":"none"}function h(t,e){var i,s,n=A(t.degree)%180,r=(n>90?180-n:n)*Math.PI/180,a=U(r),o=N(r),h=t.width,l=t.height,d=t.aspectRatio;return e?(i=h/(o+a/d),s=i/d):(i=h*o+l*a,s=h*a+l*o),{width:i,height:s}}function l(e,i){var s=t("<canvas>")[0],n=s.getContext("2d"),r=i.naturalWidth,a=i.naturalHeight,o=i.rotate,l=h({width:r,height:a,degree:o});return o?(s.width=l.width,s.height=l.height,n.save(),n.translate(l.width/2,l.height/2),n.rotate(o*Math.PI/180),n.drawImage(e,-r/2,-a/2,r,a),n.restore()):(s.width=r,s.height=a,n.drawImage(e,0,0,r,a)),s}function d(e,i){this.$element=t(e),this.options=t.extend({},d.DEFAULTS,t.isPlainObject(i)&&i),this.ready=!1,this.built=!1,this.rotated=!1,this.cropped=!1,this.disabled=!1,this.canvas=null,this.cropBox=null,this.load()}var p=t(window),c=t(document),u=window.location,f=".cropper",g="preview"+f,m=/^(e|n|w|s|ne|nw|sw|se|all|crop|move|zoom)$/,v="cropper-modal",w="cropper-hide",b="cropper-hidden",x="cropper-invisible",y="cropper-move",C="cropper-crop",k="cropper-disabled",O="cropper-bg",S="mousedown touchstart",T="mousemove touchmove",j="mouseup mouseleave touchend touchleave touchcancel",$="wheel mousewheel DOMMouseScroll",z="dblclick",B="resize"+f,L="build"+f,D="built"+f,I="dragstart"+f,P="dragmove"+f,E="dragend"+f,R="zoomin"+f,H="zoomout"+f,F=t.isFunction(t("<canvas>")[0].getContext),_=Math.sqrt,W=Math.min,M=Math.max,A=Math.abs,U=Math.sin,N=Math.cos,X=parseFloat,Y={};Y.load=function(e){var i,s,n,o,h=this.options,l=this.$element;if(!e)if(l.is("img")){if(!l.attr("src"))return;e=l.prop("src")}else l.is("canvas")&&F&&(e=l[0].toDataURL());e&&(n=t.Event(L),l.one(L,h.build).trigger(n),n.isDefaultPrevented()||(h.checkImageOrigin&&r(e)&&(i="anonymous",l.prop("crossOrigin")||(s=a(e))),this.$clone=o=t("<img>"),o.one("load",t.proxy(function(){var t=o.prop("naturalWidth")||o.width(),i=o.prop("naturalHeight")||o.height();this.image={naturalWidth:t,naturalHeight:i,aspectRatio:t/i,rotate:0},this.url=e,this.ready=!0,this.build()},this)).one("error",function(){o.remove()}).attr({crossOrigin:i,src:s||e}),o.addClass(w).insertAfter(l)))},Y.build=function(){var e,i,s=this.$element,n=this.$clone,r=this.options;this.ready&&(this.built&&this.unbuild(),this.$cropper=e=t(d.TEMPLATE),s.addClass(b),n.removeClass(w),this.$container=s.parent().append(e),this.$canvas=e.find(".cropper-canvas").append(n),this.$dragBox=e.find(".cropper-drag-box"),this.$cropBox=i=e.find(".cropper-crop-box"),this.$viewBox=e.find(".cropper-view-box"),this.addListeners(),this.initPreview(),r.aspectRatio=X(r.aspectRatio)||0/0,r.autoCrop?(this.cropped=!0,r.modal&&this.$dragBox.addClass(v)):i.addClass(b),r.background&&e.addClass(O),r.highlight||i.find(".cropper-face").addClass(x),r.guides||i.find(".cropper-dashed").addClass(b),r.movable||i.find(".cropper-face").data("drag","move"),r.resizable||i.find(".cropper-line, .cropper-point").addClass(b),this.setDragMode(r.dragCrop?"crop":"move"),this.built=!0,this.render(),this.setData(r.data),s.one(D,r.built).trigger(D))},Y.unbuild=function(){this.built&&(this.built=!1,this.initialImage=null,this.initialCanvas=null,this.initialCropBox=null,this.container=null,this.canvas=null,this.cropBox=null,this.removeListeners(),this.resetPreview(),this.$preview=null,this.$viewBox=null,this.$cropBox=null,this.$dragBox=null,this.$canvas=null,this.$container=null,this.$cropper.remove(),this.$cropper=null)},t.extend(Y,{render:function(){this.initContainer(),this.initCanvas(),this.initCropBox(),this.renderCanvas(),this.cropped&&this.renderCropBox()},initContainer:function(){var t=this.$element,e=this.$container,i=this.$cropper,s=this.options;i.addClass(b),t.removeClass(b),i.css(this.container={width:M(e.width(),X(s.minContainerWidth)||200),height:M(e.height(),X(s.minContainerHeight)||100)}),t.addClass(b),i.removeClass(b)},initCanvas:function(){var e=this.container,i=e.width,s=e.height,n=this.image,r=n.aspectRatio,a={aspectRatio:r,width:i,height:s};s*r>i?a.height=i/r:a.width=s*r,a.oldLeft=a.left=(i-a.width)/2,a.oldTop=a.top=(s-a.height)/2,this.canvas=a,this.limitCanvas(!0,!0),this.initialImage=t.extend({},n),this.initialCanvas=t.extend({},a)},limitCanvas:function(e,i){var s,n,r=this.options,a=r.strict,o=this.container,h=o.width,l=o.height,d=this.canvas,p=d.aspectRatio,c=this.cropBox,u=this.cropped&&c,f=this.initialCanvas||d,g=f.width,m=f.height;e&&(s=X(r.minCanvasWidth)||0,n=X(r.minCanvasHeight)||0,s?(a&&(s=M(u?c.width:g,s)),n=s/p):n?(a&&(n=M(u?c.height:m,n)),s=n*p):a&&(u?(s=c.width,n=c.height,n*p>s?s=n*p:n=s/p):(s=g,n=m)),t.extend(d,{minWidth:s,minHeight:n,maxWidth:1/0,maxHeight:1/0})),i&&(a?u?(d.minLeft=W(c.left,c.left+c.width-d.width),d.minTop=W(c.top,c.top+c.height-d.height),d.maxLeft=c.left,d.maxTop=c.top):(d.minLeft=W(0,h-d.width),d.minTop=W(0,l-d.height),d.maxLeft=M(0,h-d.width),d.maxTop=M(0,l-d.height)):(d.minLeft=-d.width,d.minTop=-d.height,d.maxLeft=h,d.maxTop=l))},renderCanvas:function(t){var e,i,s=this.options,n=this.canvas,r=this.image;this.rotated&&(this.rotated=!1,i=h({width:r.width,height:r.height,degree:r.rotate}),e=i.width/i.height,e!==n.aspectRatio&&(n.left-=(i.width-n.width)/2,n.top-=(i.height-n.height)/2,n.width=i.width,n.height=i.height,n.aspectRatio=e,this.limitCanvas(!0,!1))),(n.width>n.maxWidth||n.width<n.minWidth)&&(n.left=n.oldLeft),(n.height>n.maxHeight||n.height<n.minHeight)&&(n.top=n.oldTop),n.width=W(M(n.width,n.minWidth),n.maxWidth),n.height=W(M(n.height,n.minHeight),n.maxHeight),this.limitCanvas(!1,!0),n.oldLeft=n.left=W(M(n.left,n.minLeft),n.maxLeft),n.oldTop=n.top=W(M(n.top,n.minTop),n.maxTop),this.$canvas.css({width:n.width,height:n.height,left:n.left,top:n.top}),this.renderImage(),this.cropped&&s.strict&&this.limitCropBox(!0,!0),t&&this.output()},renderImage:function(){var e,i=this.canvas,s=this.image;s.rotate&&(e=h({width:i.width,height:i.height,degree:s.rotate,aspectRatio:s.aspectRatio},!0)),t.extend(s,e?{width:e.width,height:e.height,left:(i.width-e.width)/2,top:(i.height-e.height)/2}:{width:i.width,height:i.height,left:0,top:0}),this.$clone.css({width:s.width,height:s.height,marginLeft:s.left,marginTop:s.top,transform:o(s.rotate)})},initCropBox:function(){var e=this.options,i=this.canvas,s=e.aspectRatio,n=X(e.autoCropArea)||.8,r={width:i.width,height:i.height};s&&(i.height*s>i.width?r.height=r.width/s:r.width=r.height*s),this.cropBox=r,this.limitCropBox(!0,!0),r.width=W(M(r.width,r.minWidth),r.maxWidth),r.height=W(M(r.height,r.minHeight),r.maxHeight),r.width=M(r.minWidth,r.width*n),r.height=M(r.minHeight,r.height*n),r.oldLeft=r.left=i.left+(i.width-r.width)/2,r.oldTop=r.top=i.top+(i.height-r.height)/2,this.initialCropBox=t.extend({},r)},limitCropBox:function(t,e){var i,s,n=this.options,r=n.strict,a=this.container,o=a.width,h=a.height,l=this.canvas,d=this.cropBox,p=n.aspectRatio;t&&(i=X(n.minCropBoxWidth)||0,s=X(n.minCropBoxHeight)||0,d.minWidth=W(o,i),d.minHeight=W(h,s),d.maxWidth=W(o,r?l.width:o),d.maxHeight=W(h,r?l.height:h),p&&(d.maxHeight*p>d.maxWidth?(d.minHeight=d.minWidth/p,d.maxHeight=d.maxWidth/p):(d.minWidth=d.minHeight*p,d.maxWidth=d.maxHeight*p)),d.minWidth=W(d.maxWidth,d.minWidth),d.minHeight=W(d.maxHeight,d.minHeight)),e&&(r?(d.minLeft=M(0,l.left),d.minTop=M(0,l.top),d.maxLeft=W(o,l.left+l.width)-d.width,d.maxTop=W(h,l.top+l.height)-d.height):(d.minLeft=0,d.minTop=0,d.maxLeft=o-d.width,d.maxTop=h-d.height))},renderCropBox:function(){var t=this.options,e=this.container,i=e.width,s=e.height,n=this.$cropBox,r=this.cropBox;(r.width>r.maxWidth||r.width<r.minWidth)&&(r.left=r.oldLeft),(r.height>r.maxHeight||r.height<r.minHeight)&&(r.top=r.oldTop),r.width=W(M(r.width,r.minWidth),r.maxWidth),r.height=W(M(r.height,r.minHeight),r.maxHeight),this.limitCropBox(!1,!0),r.oldLeft=r.left=W(M(r.left,r.minLeft),r.maxLeft),r.oldTop=r.top=W(M(r.top,r.minTop),r.maxTop),t.movable&&n.find(".cropper-face").data("drag",r.width===i&&r.height===s?"move":"all"),n.css({width:r.width,height:r.height,left:r.left,top:r.top}),this.cropped&&t.strict&&this.limitCanvas(!0,!0),this.disabled||this.output()},output:function(){var t=this.options;this.preview(),t.crop&&t.crop.call(this.$element,this.getData())}}),Y.initPreview=function(){var e=this.url;this.$preview=t(this.options.preview),this.$viewBox.html('<img src="'+e+'">'),this.$preview.each(function(){var i=t(this);i.data(g,{width:i.width(),height:i.height(),original:i.html()}).html('<img src="'+e+'" style="display:block;width:100%;min-width:0!important;min-height:0!important;max-width:none!important;max-height:none!important;image-orientation: 0deg!important">')})},Y.resetPreview=function(){this.$preview.each(function(){var e=t(this);e.html(e.data(g).original).removeData(g)})},Y.preview=function(){var e=this.image,i=this.canvas,s=this.cropBox,n=e.width,r=e.height,a=s.left-i.left-e.left,h=s.top-i.top-e.top,l=e.rotate;this.cropped&&!this.disabled&&(this.$viewBox.find("img").css({width:n,height:r,marginLeft:-a,marginTop:-h,transform:o(l)}),this.$preview.each(function(){var e=t(this),i=e.data(g),d=i.width/s.width,p=i.width,c=s.height*d;c>i.height&&(d=i.height/s.height,p=s.width*d,c=i.height),e.width(p).height(c).find("img").css({width:n*d,height:r*d,marginLeft:-a*d,marginTop:-h*d,transform:o(l)})}))},Y.addListeners=function(){var e=this.options;this.$element.on(I,e.dragstart).on(P,e.dragmove).on(E,e.dragend).on(R,e.zoomin).on(H,e.zoomout),this.$cropper.on(S,t.proxy(this.dragstart,this)).on(z,t.proxy(this.dblclick,this)),e.zoomable&&e.mouseWheelZoom&&this.$cropper.on($,t.proxy(this.wheel,this)),c.on(T,this._dragmove=n(this.dragmove,this)).on(j,this._dragend=n(this.dragend,this)),e.responsive&&p.on(B,this._resize=n(this.resize,this))},Y.removeListeners=function(){var t=this.options;this.$element.off(I,t.dragstart).off(P,t.dragmove).off(E,t.dragend).off(R,t.zoomin).off(H,t.zoomout),this.$cropper.off(S,this.dragstart).off(z,this.dblclick),t.zoomable&&t.mouseWheelZoom&&this.$cropper.off($,this.wheel),
c.off(T,this._dragmove).off(j,this._dragend),t.responsive&&p.off(B,this._resize)},t.extend(Y,{resize:function(){var e,i,s,n=this.$container,r=this.container;this.disabled||(s=n.width()/r.width,(1!==s||n.height()!==r.height)&&(e=this.getCanvasData(),i=this.getCropBoxData(),this.render(),this.setCanvasData(t.each(e,function(t,i){e[t]=i*s})),this.setCropBoxData(t.each(i,function(t,e){i[t]=e*s}))))},dblclick:function(){this.disabled||this.setDragMode(this.$dragBox.hasClass(C)?"move":"crop")},wheel:function(t){var e=t.originalEvent||t,i=1;this.disabled||(t.preventDefault(),e.deltaY?i=e.deltaY>0?1:-1:e.wheelDelta?i=-e.wheelDelta/120:e.detail&&(i=e.detail>0?1:-1),this.zoom(.1*-i))},dragstart:function(e){var i,s,n,r=this.options,a=e.originalEvent||e,o=a&&a.touches,h=e;if(!this.disabled){if(o){if(n=o.length,n>1){if(!r.zoomable||!r.touchDragZoom||2!==n)return;h=o[1],this.startX2=h.pageX,this.startY2=h.pageY,i="zoom"}h=o[0]}if(i=i||t(h.target).data("drag"),m.test(i)){if(e.preventDefault(),s=t.Event(I,{originalEvent:a,dragType:i}),this.$element.trigger(s),s.isDefaultPrevented())return;this.dragType=i,this.cropping=!1,this.startX=h.pageX,this.startY=h.pageY,"crop"===i&&(this.cropping=!0,this.$dragBox.addClass(v))}}},dragmove:function(e){var i,s,n=this.options,r=e.originalEvent||e,a=r&&r.touches,o=e,h=this.dragType;if(!this.disabled){if(a){if(s=a.length,s>1){if(!n.zoomable||!n.touchDragZoom||2!==s)return;o=a[1],this.endX2=o.pageX,this.endY2=o.pageY}o=a[0]}if(h){if(e.preventDefault(),i=t.Event(P,{originalEvent:r,dragType:h}),this.$element.trigger(i),i.isDefaultPrevented())return;this.endX=o.pageX,this.endY=o.pageY,this.change()}}},dragend:function(e){var i,s=this.dragType;if(!this.disabled&&s){if(e.preventDefault(),i=t.Event(E,{originalEvent:e.originalEvent||e,dragType:s}),this.$element.trigger(i),i.isDefaultPrevented())return;this.cropping&&(this.cropping=!1,this.$dragBox.toggleClass(v,this.cropped&&this.options.modal)),this.dragType=""}}}),t.extend(Y,{crop:function(){this.built&&!this.disabled&&(this.cropped||(this.cropped=!0,this.limitCropBox(!0,!0),this.options.modal&&this.$dragBox.addClass(v),this.$cropBox.removeClass(b)),this.setCropBoxData(this.initialCropBox))},reset:function(){this.built&&!this.disabled&&(this.image=t.extend({},this.initialImage),this.canvas=t.extend({},this.initialCanvas),this.cropBox=t.extend({},this.initialCropBox),this.renderCanvas(),this.cropped&&this.renderCropBox())},clear:function(){this.cropped&&!this.disabled&&(t.extend(this.cropBox,{left:0,top:0,width:0,height:0}),this.cropped=!1,this.renderCropBox(),this.limitCanvas(),this.renderCanvas(),this.$dragBox.removeClass(v),this.$cropBox.addClass(b))},destroy:function(){var t=this.$element;this.ready?(this.unbuild(),t.removeClass(b)):this.$clone&&this.$clone.remove(),t.removeData("cropper")},replace:function(t){!this.disabled&&t&&this.load(t)},enable:function(){this.built&&(this.disabled=!1,this.$cropper.removeClass(k))},disable:function(){this.built&&(this.disabled=!0,this.$cropper.addClass(k))},move:function(t,i){var s=this.canvas;this.built&&!this.disabled&&e(t)&&e(i)&&(s.left+=t,s.top+=i,this.renderCanvas(!0))},zoom:function(e){var i,s,n,r=this.canvas;if(e=X(e),e&&this.built&&!this.disabled&&this.options.zoomable){if(i=t.Event(e>0?R:H),this.$element.trigger(i),i.isDefaultPrevented())return;e=-1>=e?1/(1-e):1>=e?1+e:e,s=r.width*e,n=r.height*e,r.left-=(s-r.width)/2,r.top-=(n-r.height)/2,r.width=s,r.height=n,this.renderCanvas(!0),this.setDragMode("move")}},rotate:function(t){var e=this.image;t=X(t),t&&this.built&&!this.disabled&&this.options.rotatable&&(e.rotate=(e.rotate+t)%360,this.rotated=!0,this.renderCanvas(!0))},getData:function(){var e,i,s=this.cropBox,n=this.canvas,r=this.image;return this.built&&this.cropped?(i={x:s.left-n.left,y:s.top-n.top,width:s.width,height:s.height},e=r.width/r.naturalWidth,t.each(i,function(t,s){s/=e,i[t]=s})):i={x:0,y:0,width:0,height:0},i.rotate=this.ready?r.rotate:0,i},setData:function(i){var s,n=this.image,r=this.canvas,a={};this.built&&!this.disabled&&t.isPlainObject(i)&&(e(i.rotate)&&i.rotate!==n.rotate&&this.options.rotatable&&(n.rotate=i.rotate,this.rotated=!0,this.renderCanvas(!0)),s=n.width/n.naturalWidth,e(i.x)&&(a.left=i.x*s+r.left),e(i.y)&&(a.top=i.y*s+r.top),e(i.width)&&(a.width=i.width*s),e(i.height)&&(a.height=i.height*s),this.setCropBoxData(a))},getContainerData:function(){return this.built?this.container:{}},getImageData:function(){return this.ready?this.image:{}},getCanvasData:function(){var t,e=this.canvas;return this.built&&(t={left:e.left,top:e.top,width:e.width,height:e.height}),t||{}},setCanvasData:function(i){var s=this.canvas,n=s.aspectRatio;this.built&&!this.disabled&&t.isPlainObject(i)&&(e(i.left)&&(s.left=i.left),e(i.top)&&(s.top=i.top),e(i.width)?(s.width=i.width,s.height=i.width/n):e(i.height)&&(s.height=i.height,s.width=i.height*n),this.renderCanvas(!0))},getCropBoxData:function(){var t,e=this.cropBox;return this.built&&this.cropped&&(t={left:e.left,top:e.top,width:e.width,height:e.height}),t||{}},setCropBoxData:function(i){var s=this.cropBox,n=this.options.aspectRatio;this.built&&this.cropped&&!this.disabled&&t.isPlainObject(i)&&(e(i.left)&&(s.left=i.left),e(i.top)&&(s.top=i.top),e(i.width)&&(s.width=i.width),e(i.height)&&(s.height=i.height),n&&(e(i.width)?s.height=s.width/n:e(i.height)&&(s.width=s.height*n)),this.renderCropBox())},getCroppedCanvas:function(e){var i,s,n,r,a,o,h,d,p,c,u;if(this.built&&this.cropped&&F)return t.isPlainObject(e)||(e={}),u=this.getData(),i=u.width,s=u.height,d=i/s,t.isPlainObject(e)&&(a=e.width,o=e.height,a?(o=a/d,h=a/i):o&&(a=o*d,h=o/s)),n=a||i,r=o||s,p=t("<canvas>")[0],p.width=n,p.height=r,c=p.getContext("2d"),e.fillColor&&(c.fillStyle=e.fillColor,c.fillRect(0,0,n,r)),c.drawImage.apply(c,function(){var t,e,n,r,a,o,d=l(this.$clone[0],this.image),p=d.width,c=d.height,f=[d],g=u.x,m=u.y;return-i>=g||g>p?g=t=n=a=0:0>=g?(n=-g,g=0,t=a=W(p,i+g)):p>=g&&(n=0,t=a=W(i,p-g)),0>=t||-s>=m||m>c?m=e=r=o=0:0>=m?(r=-m,m=0,e=o=W(c,s+m)):c>=m&&(r=0,e=o=W(s,c-m)),f.push(g,m,t,e),h&&(n*=h,r*=h,a*=h,o*=h),a>0&&o>0&&f.push(n,r,a,o),f}.call(this)),p},setAspectRatio:function(t){var e=this.options;this.disabled||i(t)||(e.aspectRatio=X(t)||0/0,this.built&&(this.initCropBox(),this.cropped&&this.renderCropBox()))},setDragMode:function(t){var e=this.$dragBox,i=!1,s=!1;if(this.ready&&!this.disabled){switch(t){case"crop":this.options.dragCrop?(i=!0,e.data("drag",t)):s=!0;break;case"move":s=!0,e.data("drag",t);break;default:e.removeData("drag")}e.toggleClass(C,i).toggleClass(y,s)}}}),Y.change=function(){var t,e=this.dragType,i=this.options,s=this.canvas,n=this.container,r=this.cropBox,a=r.width,o=r.height,h=r.left,l=r.top,d=h+a,p=l+o,c=0,u=0,f=n.width,g=n.height,m=!0,v=i.aspectRatio,w={x:this.endX-this.startX,y:this.endY-this.startY};switch(i.strict&&(c=r.minLeft,u=r.minTop,f=c+W(n.width,s.width),g=u+W(n.height,s.height)),v&&(w.X=w.y*v,w.Y=w.x/v),e){case"all":h+=w.x,l+=w.y;break;case"e":if(w.x>=0&&(d>=f||v&&(u>=l||p>=g))){m=!1;break}a+=w.x,v&&(o=a/v,l-=w.Y/2),0>a&&(e="w",a=0);break;case"n":if(w.y<=0&&(u>=l||v&&(c>=h||d>=f))){m=!1;break}o-=w.y,l+=w.y,v&&(a=o*v,h+=w.X/2),0>o&&(e="s",o=0);break;case"w":if(w.x<=0&&(c>=h||v&&(u>=l||p>=g))){m=!1;break}a-=w.x,h+=w.x,v&&(o=a/v,l+=w.Y/2),0>a&&(e="e",a=0);break;case"s":if(w.y>=0&&(p>=g||v&&(c>=h||d>=f))){m=!1;break}o+=w.y,v&&(a=o*v,h-=w.X/2),0>o&&(e="n",o=0);break;case"ne":if(v){if(w.y<=0&&(u>=l||d>=f)){m=!1;break}o-=w.y,l+=w.y,a=o*v}else w.x>=0?f>d?a+=w.x:w.y<=0&&u>=l&&(m=!1):a+=w.x,w.y<=0?l>u&&(o-=w.y,l+=w.y):(o-=w.y,l+=w.y);0>a&&0>o?(e="sw",o=0,a=0):0>a?(e="nw",a=0):0>o&&(e="se",o=0);break;case"nw":if(v){if(w.y<=0&&(u>=l||c>=h)){m=!1;break}o-=w.y,l+=w.y,a=o*v,h+=w.X}else w.x<=0?h>c?(a-=w.x,h+=w.x):w.y<=0&&u>=l&&(m=!1):(a-=w.x,h+=w.x),w.y<=0?l>u&&(o-=w.y,l+=w.y):(o-=w.y,l+=w.y);0>a&&0>o?(e="se",o=0,a=0):0>a?(e="ne",a=0):0>o&&(e="sw",o=0);break;case"sw":if(v){if(w.x<=0&&(c>=h||p>=g)){m=!1;break}a-=w.x,h+=w.x,o=a/v}else w.x<=0?h>c?(a-=w.x,h+=w.x):w.y>=0&&p>=g&&(m=!1):(a-=w.x,h+=w.x),w.y>=0?g>p&&(o+=w.y):o+=w.y;0>a&&0>o?(e="ne",o=0,a=0):0>a?(e="se",a=0):0>o&&(e="nw",o=0);break;case"se":if(v){if(w.x>=0&&(d>=f||p>=g)){m=!1;break}a+=w.x,o=a/v}else w.x>=0?f>d?a+=w.x:w.y>=0&&p>=g&&(m=!1):a+=w.x,w.y>=0?g>p&&(o+=w.y):o+=w.y;0>a&&0>o?(e="nw",o=0,a=0):0>a?(e="sw",a=0):0>o&&(e="ne",o=0);break;case"move":s.left+=w.x,s.top+=w.y,this.renderCanvas(!0),m=!1;break;case"zoom":this.zoom(function(t,e,i,s){var n=_(t*t+e*e),r=_(i*i+s*s);return(r-n)/n}(A(this.startX-this.startX2),A(this.startY-this.startY2),A(this.endX-this.endX2),A(this.endY-this.endY2))),this.startX2=this.endX2,this.startY2=this.endY2,m=!1;break;case"crop":w.x&&w.y&&(t=this.$cropper.offset(),h=this.startX-t.left,l=this.startY-t.top,a=r.minWidth,o=r.minHeight,w.x>0?w.y>0?e="se":(e="ne",l-=o):w.y>0?(e="sw",h-=a):(e="nw",h-=a,l-=o),this.cropped||(this.cropped=!0,this.$cropBox.removeClass(b)))}m&&(r.width=a,r.height=o,r.left=h,r.top=l,this.dragType=e,this.renderCropBox()),this.startX=this.endX,this.startY=this.endY},t.extend(d.prototype,Y),d.DEFAULTS={aspectRatio:0/0,autoCropArea:.8,crop:null,data:null,preview:"",strict:!0,responsive:!0,checkImageOrigin:!0,modal:!0,guides:!0,highlight:!0,background:!0,autoCrop:!0,dragCrop:!0,movable:!0,resizable:!0,rotatable:!0,zoomable:!0,touchDragZoom:!0,mouseWheelZoom:!0,minCanvasWidth:0,minCanvasHeight:0,minCropBoxWidth:0,minCropBoxHeight:0,minContainerWidth:200,minContainerHeight:100,build:null,built:null,dragstart:null,dragmove:null,dragend:null,zoomin:null,zoomout:null},d.setDefaults=function(e){t.extend(d.DEFAULTS,e)},d.TEMPLATE=function(t,e){return e=e.split(","),t.replace(/\d+/g,function(t){return e[t]})}('<0 6="5-container"><0 6="5-canvas"></0><0 6="5-2-9" 3-2="move"></0><0 6="5-crop-9"><1 6="5-view-9"></1><1 6="5-8 8-h"></1><1 6="5-8 8-v"></1><1 6="5-face" 3-2="all"></1><1 6="5-7 7-e" 3-2="e"></1><1 6="5-7 7-n" 3-2="n"></1><1 6="5-7 7-w" 3-2="w"></1><1 6="5-7 7-s" 3-2="s"></1><1 6="5-4 4-e" 3-2="e"></1><1 6="5-4 4-n" 3-2="n"></1><1 6="5-4 4-w" 3-2="w"></1><1 6="5-4 4-s" 3-2="s"></1><1 6="5-4 4-ne" 3-2="ne"></1><1 6="5-4 4-nw" 3-2="nw"></1><1 6="5-4 4-sw" 3-2="sw"></1><1 6="5-4 4-se" 3-2="se"></1></0></0>',"div,span,drag,data,point,cropper,class,line,dashed,box"),d.other=t.fn.cropper,t.fn.cropper=function(e){var n,r=s(arguments,1);return this.each(function(){var i,s=t(this),a=s.data("cropper");a||s.data("cropper",a=new d(this,e)),"string"==typeof e&&t.isFunction(i=a[e])&&(n=i.apply(a,r))}),i(n)?this:n},t.fn.cropper.Constructor=d,t.fn.cropper.setDefaults=d.setDefaults,t.fn.cropper.noConflict=function(){return t.fn.cropper=d.other,this}});