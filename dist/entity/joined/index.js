$(function(){"use strict";function e(e){f=e;var n=location.pathname.split("/").slice(1)[1];$.getJSON("/services/entity/"+n,function(e){if("success"==e.status){var n=e.data;$.getJSON("/services/theme/"+n.themeId,function(e){"success"==e.status&&(n.Theme=e.data,t(n))})}else console.error(e.data)})}function t(e){g.entity=e,$('<link rel="stylesheet"/>').attr("href","/page/"+e.Theme.code+"/css/style.css").appendTo("head"),$.get("/page/"+e.Theme.code+"/index.html",function(e){$('<script id="card-template" type="text/html"/>').html(e).appendTo("body"),p=$(".panel"),n(),i(),a(),o(),r()})}function n(){var e=$(".join-footer-bar");e.find(".join-footer-bar-list").on("click",function(){s(),m.addClass("smaller"),v.addClass("in")}),e.find(".join-footer-bar-add").on("click",function(){r()}),e.find(".join-footer-bar-layout").on("click",function(){l(g.cards[y.activeIndex]),m.addClass("smaller"),h.addClass("in")}),e.find(".join-footer-bar-publish").on("click",function(){var e=[],t=g.cards.every(function(t,n){e.push({contents:t.contents,pictures:t.pictures,layoutId:t.Layout.id});var i=$(y.slides[n]),a=i.find(".picture").length,s=i.find(".content").length,o=t.pictures.filter(function(e){return e!=w}),l=t.contents.filter(function(e){return e});if(a){if(o.length<a)return y.slideTo(n),alert("请先上传图片再发布！"),!1}else if(l.length<s)return y.slideTo(n),alert("请先上传填写文字再发布！"),!1;return!0});if(t){var n=$.param({_username:f.username,_password:f.password}),i={entityId:g.entity.id,cards:e};$.post("/services/post?"+n,i,function(e){"success"==e.status?location.href="/entity/"+e.data.entityId+"?pid="+e.data.id:console.error(e)})}})}function i(){m=$(".preview-container").append(template("preview-template",g)),y=new Swiper(m[0],{preloadImages:!1,lazyLoading:!0,lazyLoadingInPrevNext:!0,lazyLoadingOnTransitionStart:!0,onTap:function(){m.removeClass("smaller"),v.removeClass("in"),h.removeClass("in")}})}function a(){v=$(".card-list");var e=v.find(".swiper-container"),t=e.height(),n=p.height(),i=t/n;e.css({width:p.width(),height:n,transform:"scale("+i+")"}),v.find(".join-bar-close").on("click",function(){m.removeClass("smaller"),v.removeClass("in")}),v.find(".join-bar-save").on("click",function(){m.removeClass("smaller"),v.removeClass("in")}),v.on("click",".join-bar-remove",function(){var e=$(this).parent().index();g.cards.splice(e,1),s()})}function s(){var e=$(".card-list .swiper-container").html(template("card-list-template",g));new Swiper(e[0],{slideActiveClass:"active",initialSlide:y.activeIndex,spaceBetween:200,slideToClickedSlide:!0,preloadImages:!1,lazyLoading:!0,lazyLoadingInPrevNext:!0,lazyLoadingOnTransitionStart:!0,onSlideChangeStart:function(e){y.slideTo(e.activeIndex)}})}function o(){h=$(".layout-list"),h.find(".join-bar-close").on("click",function(){m.removeClass("smaller"),h.removeClass("in")}),h.find(".join-bar-save").on("click",function(){m.removeClass("smaller"),h.removeClass("in")})}function l(e){var t,n,i=g.entity.Theme,a=$(".layout-list .swiper-container").html(template("layout-list-template",i));for(t=0,n=i.Layouts.length;n>t&&e.Layout.code!=i.Layouts[t].code;t++);new Swiper(a[0],{slideActiveClass:"active",initialSlide:t,slidesPerView:3,centeredSlides:!0,slideToClickedSlide:!0,onTap:function(t){var n=t.activeIndex,a=i.Layouts[n];e.Layout=a,e.layoutId=a.id,c(e)}})}function r(){var e=g.entity.Theme.Layouts[0],t={layoutId:e.id,Layout:e,contents:[],pictures:[w]};if(g.cards.push(t),y){y.appendSlide('<div class="swiper-slide">'+template("card-template",t)+"</div>");var n=y.slides.length-1,i=$(y.slides[n]);y.slideTo(n),y.lazy.loadImageInSlide(n),d(i,t)}}function c(e){var t=g.cards.indexOf(e);y&&(y.slides[t].innerHTML=template("card-template",e),y.lazy.loadImageInSlide(t),d($(y.slides[t]),e))}function d(e,t){e.find(".picture").each(function(e){t.pictures[e]!=w&&$(this).addClass("uploaded"),u(this,t,e)}),e.find(".content").each(function(e){var n=$(this),i=n.html();n.html("");var a=$('<textarea class="input-content"/>').attr("placeholder","输入内容").appendTo(n);a.val(i),a.on("blur",function(){t.contents[e]=a.val()})})}function u(e,t,n){var i=new Flow({target:"/upload",chunkSize:1048576,testChunks:!1});i.assignBrowse(e,!1,!0,{accept:"image/*"}),i.on("filesSubmitted",function(e){i.upload()}),i.on("fileSuccess",function(e,i){try{var a=JSON.parse(i);if("success"==a.status){var s=a.data[0].replace(/\\/g,"/");t.pictures[n]=s,c(t)}else console.log(a)}catch(o){console.error(i)}})}var f,p,m,v,h,y,g={cards:[]},w="/entity/join/img/picture-placeholder.jpg";e({username:"admin",password:"21232f297a57a5a743894a0e4a801fc3"})});